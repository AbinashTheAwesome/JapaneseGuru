<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marksheet Analysis Generator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f4f4f9;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
    }
    input[type="text"], input[type="number"], input[type="file"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .radio-group {
      display: flex;
      gap: 10px;
    }
    button {
      padding: 10px 15px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background-color: #0056b3;
    }
    .notes {
      font-size: 0.9em;
      color: #555;
      background-color: #e9ecef;
      padding: 10px;
      border-radius: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 9pt;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 5px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
      width: 25%;
    }
    #results {
      margin-top: 20px;
    }
    .student-page {
      page-break-after: always;
      position: relative;
      height: 277mm;
      width: 190mm;
      margin: 10px auto;
      padding: 10mm;
      box-sizing: border-box;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .charts {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 15px;
    }
    .chart-container {
      position: relative;
      width: 100%;
      height: 500px;
    }
    .pass-fail-container {
      margin: 15px 0;
    }
    .pass-fail-visual {
      width: 100%;
      height: 40px;
      display: flex;
      border: 1px solid #ddd;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .pass-section {
      background-color: #4CAF50;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    .fail-section {
      background-color: #F44336;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    .pass-fail-table {
      width: 100%;
      border-collapse: collapse;
    }
    .pass-fail-table th, .pass-fail-table td {
      padding: 5px;
      text-align: center;
      border: 1px solid #ddd;
    }
    .pass-fail-table th {
      background-color: #f2f2f2;
    }
    canvas {
      max-width: 100%;
    }
    @media print {
      .no-print {
        display: none !important;
      }
      
      body, html {
        margin: 0;
        padding: 0;
        background: white;
        width: 100%;
        height: 100%;
      }
      #results {
        margin: 0;
        padding: 0;
        width: 100%;
      }
      .student-page {
        height: 277mm;
        width: 190mm;
        margin: 0;
        padding: 10mm;
        font-size: 9pt;
        box-shadow: none;
        page-break-inside: avoid;
      }
      .student-header {
        text-align: center;
        margin-bottom: 10px;
        font-size: 14pt;
      }
      .student-table {
        width: 100%;
        margin-bottom: 10px;
      }
      .charts {
        display: flex;
        flex-direction: column;
        width: 100%;
        margin-top: 5mm;
      }
      .chart-container {
        width: 100%;
        height: 500px;
      }
      .chart-container canvas {
        width: 100% !important;
        height: 100% !important;
      }
      .pass-fail-visual {
        height: 30px;
      }
          .pass-section {
        background-color: #4CAF50 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        color: white !important;
      }
      
      .fail-section {
        background-color: #F44336 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        color: white !important;
      }

    }
    @media (max-width: 600px) {
      body {
        padding: 10px;
      }
      .radio-group {
        flex-direction: column;
      }
      .student-page {
        width: 100%;
        padding: 5mm;
      }
      .charts {
        flex-direction: column;
      }
      .chart-container {
        height: 500px;
      }
      .pass-section {
    background-color: #4CAF50 !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    color: white !important;
  }
  .fail-section {
    background-color: #F44336 !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    color: white !important;
  }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
  <main class="no-print">
    <h1>Marksheet Analysis Generator</h1>
    <form id="data-form" onsubmit="handleAnalyze(event)">
      <section>
        <h2>School Details</h2>
        <div class="form-group">
          <label for="school-name">School Name</label>
          <input type="text" id="school-name" name="school-name" required>
        </div>
      </section>

      <section>
        <h2>Student Details</h2>
        <div class="form-group">
          <label for="class-grade">Class / Grade</label>
          <input type="text" id="class-grade" name="class-grade" required>
        </div>
        <div class="form-group">
          <label for="term">Term</label>
          <input type="text" id="term" name="term" required>
        </div>
        <div class="form-group">
          <label for="year-bs">Year (B.S.)</label>
          <input type="text" id="year-bs" name="year-bs" required>
        </div>
        <div class="form-group">
          <label for="issue-date">Issue Date (B.S.)</label>
          <input type="text" id="issue-date" name="issue-date" required>
        </div>
      </section>

      <section>
        <h2>Marks Configuration</h2>
        <div class="form-group">
          <label for="theory-pass">Theory Pass Marks</label>
          <input type="number" id="theory-pass" name="theory-pass" min="0" required>
        </div>
        <div class="form-group">
          <label for="practical-pass">Practical Pass Marks</label>
          <input type="number" id="practical-pass" name="practical-pass" min="0" required>
        </div>
        <div class="form-group">
          <label for="theory-full">Theory Full Marks</label>
          <input type="number" id="theory-full" name="theory-full" min="0" required>
        </div>
        <div class="form-group">
          <label for="practical-full">Practical Full Marks</label>
          <input type="number" id="practical-full" name="practical-full" min="0" required>
        </div>
      </section>

      <section>
        <h2>Analysis Mode</h2>
        <div class="radio-group">
          <label><input type="radio" name="analysis-mode" value="total" checked> Total</label>
          <label><input type="radio" name="analysis-mode" value="theory"> Theory</label>
          <label><input type="radio" name="analysis-mode" value="practical"> Practical</label>
        </div>
      </section>

      <section>
        <h2>Display Mode</h2>
        <div class="radio-group">
          <label><input type="radio" name="display-mode" value="marks" checked> Marks</label>
          <label><input type="radio" name="display-mode" value="grades"> Grades</label>
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="show-percentage" name="show-percentage"> Show Percentage Alongside GPA</label>
        </div>
      </section>

      <section>
        <h2>Subject Management</h2>
        <table id="subject-table">
          <thead>
            <tr><th>Subject Name</th><th>Action</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <button type="button" onclick="addSubject()">‚ûï Add Subject</button>
      </section>

      
      <section>
        <h2>Upload Marks File</h2>
        <div class="form-group">
          <label for="data-file">Upload .xlsx or .csv file</label>
          <input type="file" id="data-file" name="data-file" accept=".xlsx,.csv" required>
        </div>
        <p class="notes">
          <strong>File Format Notes:</strong> Must include Roll and Name columns. Subject columns like Subject_Math_TH, Subject_Math_PR. Attendance: TotalDays, Present, Absent (optional).
          <a href="data:text/csv;charset=utf-8,Roll,Name,Subject_Math_TH,Subject_Math_PR,Subject_Science_TH,Subject_Science_PR,TotalDays,Present,Absent%0A1,Student A,80,18,75,20,100,95,5%0A2,Student B,60,15,50,10,100,90,10%0A3,Student C,90,20,85,19,100,92,8%0A4,Student D,70,12,65,15,100,88,12%0A5,Student E,85,17,80,18,100,94,6%0A6,Student F,55,10,45,8,100,85,15%0A7,Student G,95,22,90,20,100,96,4%0A8,Student H,65,14,60,12,100,89,11%0A9,Student I,75,16,70,14,100,91,9%0A10,Student J,50,9,40,7,100,87,13" download="sample.csv">Download sample file</a>.
        </p>
      </section>

      <section>
        <button type="button" onclick="loadSample()" aria-label="Load Sample Data">üìù Load Sample</button>
        <button type="submit" aria-label="Generate Results">üéØ Generate Results</button>
        <button type="button" onclick="printResults()" aria-label="Print Results">üñ®Ô∏è Print</button>
        <button type="button" onclick="clearForm()" aria-label="Clear Form">üóëÔ∏è Clear</button>
      </section>
    </form>
  </main>

  <section id="results" aria-live="polite"></section>

  <script>
    let parsedData = [];
    let subjects = [];
    let theoryPass = 0;
    let practicalPass = 0;
    let theoryFull = 0;
    let practicalFull = 0;
    let analysisMode = 'total';
    let displayMode = 'marks';
    let showPercentage = false;
    let schoolDetails = {};
    let gradingScale = [
      { grade: 'A+', gpa: 4.0, min: 90, max: 100 },
      { grade: 'A', gpa: 3.6, min: 80, max: 89.99 },
      { grade: 'B+', gpa: 3.2, min: 70, max: 79.99 },
      { grade: 'B', gpa: 2.8, min: 60, max: 69.99 },
      { grade: 'C+', gpa: 2.4, min: 50, max: 59.99 },
      { grade: 'C', gpa: 2.0, min: 40, max: 49.99 },
      { grade: 'D', gpa: 1.6, min: 35, max: 39.99 },
      { grade: 'NG', gpa: 0.0, min: 0, max: 34.99 }
    ];
    let classAverages = {};
    let passCount = 0;
    let failCount = 0;
    let barCharts = [];

    function addSubject() {
      const tbody = document.querySelector('#subject-table tbody');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="text" class="subject-name" required></td>
        <td><button type="button" onclick="this.parentElement.parentElement.remove()">Remove</button></td>
      `;
      tbody.appendChild(row);
    }

    function resetGradingScale() {
      const tbody = document.querySelector('#grading-table tbody');
      tbody.innerHTML = `
        <tr><td>A+</td><td>4.0</td><td>90</td><td>100</td></tr>
        <tr><td>A</td><td>3.6</td><td>80</td><td>89.99</td></tr>
        <tr><td>B+</td><td>3.2</td><td>70</td><td>79.99</td></tr>
        <tr><td>B</td><td>2.8</td><td>60</td><td>69.99</td></tr>
        <tr><td>C+</td><td>2.4</td><td>50</td><td>59.99</td></tr>
        <tr><td>C</td><td>2.0</td><td>40</td><td>49.99</td></tr>
        <tr><td>D</td><td>1.6</td><td>35</td><td>39.99</td></tr>
        <tr><td>NG</td><td>0.0</td><td>0</td><td>34.99</td></tr>
      `;
    }

    function loadSample() {
      // Set default values for form fields
      document.getElementById('school-name').value = "Sample School";
      document.getElementById('class-grade').value = "10";
      document.getElementById('term').value = "First Term";
      document.getElementById('year-bs').value = "2080";
      document.getElementById('issue-date').value = "2080-01-15";
      document.getElementById('theory-pass').value = "40";
      document.getElementById('practical-pass').value = "16";
      document.getElementById('theory-full').value = "100";
      document.getElementById('practical-full').value = "25";
      
      // Add sample subjects
      const tbody = document.querySelector('#subject-table tbody');
      tbody.innerHTML = '';
      ['Math', 'Science'].forEach(subject => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input type="text" class="subject-name" value="${subject}" required></td>
          <td><button type="button" onclick="this.parentElement.parentElement.remove()">Remove</button></td>
        `;
        tbody.appendChild(row);
      });
      
      // Load sample data
      const sampleData = `Roll,Name,Subject_Math_TH,Subject_Math_PR,Subject_Science_TH,Subject_Science_PR,TotalDays,Present,Absent
1,Student A,80,18,75,20,100,95,5
2,Student B,60,15,50,10,100,90,10
3,Student C,90,20,85,19,100,92,8
4,Student D,70,12,65,15,100,88,12
5,Student E,85,17,80,18,100,94,6
6,Student F,55,10,45,8,100,85,15
7,Student G,95,22,90,20,100,96,4
8,Student H,65,14,60,12,100,89,11
9,Student I,75,16,70,14,100,91,9
10,Student J,50,9,40,7,100,87,13`;
      
      // Create a blob and file object to simulate file upload
      const blob = new Blob([sampleData], { type: 'text/csv' });
      const file = new File([blob], 'sample.csv', { type: 'text/csv' });
      
      // Create a DataTransfer to set the file input
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      document.getElementById('data-file').files = dataTransfer.files;
      
      alert('Sample data loaded (10 students). Now generate results.');
    }

    function handleAnalyze(event) {
      event.preventDefault();
      const form = document.getElementById('data-form');
      const formData = new FormData(form);
      schoolDetails.school = formData.get('school-name');
      schoolDetails.class = formData.get('class-grade');
      schoolDetails.term = formData.get('term');
      schoolDetails.year = formData.get('year-bs');
      schoolDetails.issueDate = formData.get('issue-date');
      theoryPass = parseFloat(formData.get('theory-pass')) || 0;
      practicalPass = parseFloat(formData.get('practical-pass')) || 0;
      theoryFull = parseFloat(formData.get('theory-full')) || 0;
      practicalFull = parseFloat(formData.get('practical-full')) || 0;
      analysisMode = formData.get('analysis-mode');
      displayMode = formData.get('display-mode');
      showPercentage = formData.get('show-percentage') === 'on';

      subjects = Array.from(document.querySelectorAll('.subject-name')).map(input => input.value.trim()).filter(name => name);
      if (subjects.length === 0) {
        alert('Please add at least one subject.');
        return;
      }
      if (subjects.length > 10) {
        alert('Maximum 10 subjects allowed for clear graph display.');
        return;
      }

      const fileInput = document.getElementById('data-file');
      if (!fileInput.files.length) {
        alert('Please upload a file.');
        return;
      }
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        if (file.name.endsWith('.csv')) {
          parseCSV(e.target.result);
        } else if (file.name.endsWith('.xlsx')) {
          parseXLSX(e.target.result);
        }
      };
      if (file.name.endsWith('.xlsx')) {
        reader.readAsArrayBuffer(file);
      } else {
        reader.readAsText(file);
      }
    }

    function parseCSV(data) {
      Papa.parse(data, {
        header: true,
        complete: function(results) {
          processData(results.data);
        }
      });
    }

    function parseXLSX(data) {
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const json = XLSX.utils.sheet_to_json(worksheet);
      processData(json);
    }

    function getGradeAndGPA(marks, fullMarks) {
      const percentage = (marks / fullMarks) * 100;
      for (const scale of gradingScale) {
        if (percentage >= scale.min && percentage <= scale.max) {
          return { grade: scale.grade, gpa: scale.gpa };
        }
      }
      return { grade: 'NG', gpa: 0.0 };
    }

    function processData(data) {
      parsedData = data.filter(row => row.Roll && row.Name);
      if (parsedData.length === 0) {
        alert('No valid data found. Check file format.');
        return;
      }

      // Initialize class averages
      classAverages = {};
      subjects.forEach(sub => {
        classAverages[sub] = { theory: { total: 0, count: 0 }, practical: { total: 0, count: 0 }, total: { total: 0, count: 0 } };
      });

      // Process student data
      parsedData.forEach(student => {
        student.theoryMarks = 0;
        student.practicalMarks = 0;
        student.totalMarks = 0;
        student.theoryGpaSum = 0;
        student.practicalGpaSum = 0;
        student.totalGpaSum = 0;
        student.subjects = {};
        let theoryAllPassed = true;
        let practicalAllPassed = true;
        let totalAllPassed = true;
        let failedSubjects = [];

        subjects.forEach(sub => {
          const thKey = `Subject_${sub}_TH`;
          const prKey = `Subject_${sub}_PR`;
          const th = parseFloat(student[thKey]) || 0;
          const pr = parseFloat(student[prKey]) || 0;
          const total = th + pr;
          student.subjects[sub] = { th, pr, total };

          // Update class averages
          if (th) {
            classAverages[sub].theory.total += th;
            classAverages[sub].theory.count += 1;
          }
          if (pr) {
            classAverages[sub].practical.total += pr;
            classAverages[sub].practical.count += 1;
          }
          if (th || pr) {
            classAverages[sub].total.total += total;
            classAverages[sub].total.count += 1;
          }

          // Pass/fail per subject
          const thPass = th >= theoryPass || th === 0;
          const prPass = pr >= practicalPass || pr === 0;
          if (!thPass) {
            theoryAllPassed = false;
            failedSubjects.push(`${sub} (Theory)`);
          }
          if (!prPass) {
            practicalAllPassed = false;
            failedSubjects.push(`${sub} (Practical)`);
          }
          if (!thPass || !prPass) {
            totalAllPassed = false;
          }

          // GPA calculation
          student.theoryGpaSum += getGradeAndGPA(th, theoryFull).gpa;
          student.practicalGpaSum += getGradeAndGPA(pr, practicalFull).gpa;
          student.totalGpaSum += getGradeAndGPA(total, theoryFull + practicalFull).gpa;

          student.theoryMarks += th;
          student.practicalMarks += pr;
          student.totalMarks += total;
        });

        student.theoryGpa = student.theoryGpaSum / subjects.length;
        student.practicalGpa = student.practicalGpaSum / subjects.length;
        student.totalGpa = student.totalGpaSum / subjects.length;
        student.theoryPercentage = (student.theoryMarks / (subjects.length * theoryFull)) * 100;
        student.practicalPercentage = (student.practicalMarks / (subjects.length * practicalFull)) * 100;
        student.totalPercentage = (student.totalMarks / (subjects.length * (theoryFull + practicalFull))) * 100;
        student.theoryPass = theoryAllPassed;
        student.practicalPass = practicalAllPassed;
        student.totalPass = totalAllPassed;
        student.failedSubjects = failedSubjects;
      });

      // Finalize class averages
      subjects.forEach(sub => {
        classAverages[sub].theory.avg = classAverages[sub].theory.count > 0 ? classAverages[sub].theory.total / classAverages[sub].theory.count : 0;
        classAverages[sub].practical.avg = classAverages[sub].practical.count > 0 ? classAverages[sub].practical.total / classAverages[sub].practical.count : 0;
        classAverages[sub].total.avg = classAverages[sub].total.count > 0 ? classAverages[sub].total.total / classAverages[sub].total.count : 0;
      });

      // Calculate ranks
      const sortedTheory = [...parsedData].sort((a, b) => b.theoryMarks - a.theoryMarks);
      const sortedPractical = [...parsedData].sort((a, b) => b.practicalMarks - a.practicalMarks);
      const sortedTotal = [...parsedData].sort((a, b) => b.totalMarks - a.totalMarks);
      let theoryRank = 1, practicalRank = 1, totalRank = 1;
      let lastTheoryMarks = null, lastPracticalMarks = null, lastTotalMarks = null;
      sortedTheory.forEach((student, index) => {
        if (index > 0 && student.theoryMarks === lastTheoryMarks) {
          student.theoryRank = theoryRank;
        } else {
          student.theoryRank = index + 1;
          theoryRank = index + 1;
        }
        lastTheoryMarks = student.theoryMarks;
      });
      sortedPractical.forEach((student, index) => {
        if (index > 0 && student.practicalMarks === lastPracticalMarks) {
          student.practicalRank = practicalRank;
        } else {
          student.practicalRank = index + 1;
          practicalRank = index + 1;
        }
        lastPracticalMarks = student.practicalMarks;
      });
      sortedTotal.forEach((student, index) => {
        if (index > 0 && student.totalMarks === lastTotalMarks) {
          student.totalRank = totalRank;
        } else {
          student.totalRank = index + 1;
          totalRank = index + 1;
        }
        lastTotalMarks = student.totalMarks;
      });

      // Calculate pass/fail for visual representation
      passCount = parsedData.filter(s => analysisMode === 'theory' ? s.theoryPass : analysisMode === 'practical' ? s.practicalPass : s.totalPass).length;
      failCount = parsedData.length - passCount;

      renderResults();
    }

    function renderResults() {
      // Clear previous charts
      barCharts.forEach(chart => chart.destroy());
      barCharts = [];
      
      const results = document.getElementById('results');
      results.innerHTML = '';

      parsedData.forEach((student, index) => {
        const gpa = analysisMode === 'theory' ? student.theoryGpa : analysisMode === 'practical' ? student.practicalGpa : student.totalGpa;
        const totalMarks = analysisMode === 'theory' ? student.theoryMarks : analysisMode === 'practical' ? student.practicalMarks : student.totalMarks;
        const fullMarks = analysisMode === 'theory' ? subjects.length * theoryFull : analysisMode === 'practical' ? subjects.length * practicalFull : subjects.length * (theoryFull + practicalFull);
        const percentage = analysisMode === 'theory' ? student.theoryPercentage : analysisMode === 'practical' ? student.practicalPercentage : student.totalPercentage;
        const rank = analysisMode === 'theory' ? student.theoryRank : analysisMode === 'practical' ? student.practicalRank : student.totalRank;
        const status = analysisMode === 'theory' ? student.theoryPass : analysisMode === 'practical' ? student.practicalPass : student.totalPass;
        const totalMarksDisplay = displayMode === 'marks' ? `${totalMarks}/${fullMarks}` : `${gpa.toFixed(2)}${showPercentage ? ` (${percentage.toFixed(2)}%)` : ''}`;

        const page = document.createElement('div');
        page.className = 'student-page';
        page.id = `student-${index}`;
        page.innerHTML = `
          <h2 class="student-header">${schoolDetails.school}</h2>
          <table class="student-table">
            <tr><th>Name</th><td>${student.Name}</td><th>Class</th><td>${schoolDetails.class}</td></tr>
            <tr><th>Roll No</th><td>${student.Roll}</td><th>Term</th><td>${schoolDetails.term}</td></tr>
            <tr><th>Year (B.S.)</th><td>${schoolDetails.year}</td><th>Issue Date (B.S.)</th><td>${schoolDetails.issueDate}</td></tr>
            <tr><th>GPA</th><td>${gpa.toFixed(2)}</td><th>Total Marks</th><td>${totalMarksDisplay}</td></tr>
            <tr><th>Rank</th><td>${rank}</td><th>Status</th><td>${status ? 'Pass' : `Fail (${student.failedSubjects.join(', ')})`}</td></tr>
            ${student.TotalDays ? `<tr><th>Attendance</th><td colspan="3">${student.Present}/${student.TotalDays} (${((student.Present / student.TotalDays) * 100).toFixed(2)}%)</td></tr>` : ''}
          </table>
          
          <div class="pass-fail-container">
            <h3>Class Pass/Fail Ratio</h3>
            <div class="pass-fail-visual">
              <div class="pass-section" style="width: ${(passCount / parsedData.length) * 100}%">
                ${Math.round((passCount / parsedData.length) * 100)}%
              </div>
              <div class="fail-section" style="width: ${(failCount / parsedData.length) * 100}%">
                ${Math.round((failCount / parsedData.length) * 100)}%
              </div>
            </div>
            <table class="pass-fail-table">
              <tr>
                <th>Status</th>
                <th>Count</th>
                <th>Percentage</th>
              </tr>
              <tr>
                <td>Pass</td>
                <td>${passCount}</td>
                <td>${((passCount / parsedData.length) * 100).toFixed(2)}%</td>
              </tr>
              <tr>
                <td>Fail</td>
                <td>${failCount}</td>
                <td>${((failCount / parsedData.length) * 100).toFixed(2)}%</td>
              </tr>
              <tr>
                <td>Total</td>
                <td>${parsedData.length}</td>
                <td>100%</td>
              </tr>
            </table>
          </div>
          
          <div class="charts">
            <div class="chart-container">
              <canvas id="barChart-${index}"></canvas>
            </div>
          </div>
        `;
        results.appendChild(page);

        // Bar Chart
        const barCtx = document.getElementById(`barChart-${index}`);
        const studentData = subjects.map(sub => {
          const marks = analysisMode === 'theory' ? student.subjects[sub].th : analysisMode === 'practical' ? student.subjects[sub].pr : student.subjects[sub].total;
          const avg = analysisMode === 'theory' ? classAverages[sub].theory.avg : analysisMode === 'practical' ? classAverages[sub].practical.avg : classAverages[sub].total.avg;
          return {
            value: marks,
            color: marks > avg ? '#4CAF50' : marks === avg ? '#2196F3' : '#F44336'
          };
        });
        const yAxisMax = analysisMode === 'theory' ? theoryFull : analysisMode === 'practical' ? practicalFull : theoryFull + practicalFull;
        
        const barChart = new Chart(barCtx, {
          type: 'bar',
          data: {
            labels: subjects,
            datasets: [
              {
                label: 'Student',
                data: studentData.map(d => d.value),
                backgroundColor: studentData.map(d => d.color),
                borderColor: studentData.map(d => d.color),
                borderWidth: 1
              },
              {
                label: 'Class Average',
                data: subjects.map(sub => analysisMode === 'theory' ? classAverages[sub].theory.avg : analysisMode === 'practical' ? classAverages[sub].practical.avg : classAverages[sub].total.avg),
                backgroundColor: '#FFC107',
                borderColor: '#FFC107',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { 
              y: { 
                beginAtZero: true, 
                max: yAxisMax,
                title: {
                  display: true,
                  text: 'Marks'
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'Subjects'
                }
              }
            },
            plugins: { 
              legend: { 
                display: true, 
                position: 'top' 
              },
              title: {
                display: true,
                text: 'Subject-wise Performance'
              }
            }
          }
        });
        barCharts.push(barChart);
      });
    }

    function printResults() {
      if (parsedData.length === 0) {
        alert('Generate results first.');
        return;
      }
      
      // Resize charts for printing
      barCharts.forEach(chart => {
        chart.options.maintainAspectRatio = false;
        chart.resize();
      });
      
      window.print();
    }

    function clearForm() {
      document.getElementById('data-form').reset();
      document.querySelector('#subject-table tbody').innerHTML = '';
      document.getElementById('results').innerHTML = '';
      parsedData = [];
      subjects = [];
      classAverages = {};
      passCount = 0;
      failCount = 0;
      
      // Destroy all charts
      barCharts.forEach(chart => chart.destroy());
      barCharts = [];
    }
  </script>
</body>
</html>