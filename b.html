<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marksheet Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    .container {
      display: flex;
      gap: 20px;
      padding: 20px;
    }
    .ui-left {
      width: 300px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .ui-left label {
      display: block;
      margin-bottom: 5px;
    }
    .ui-left input, .ui-left button {
      width: 100%;
      padding: 5px;
      margin-top: 3px;
    }
    .ui-right {
      flex: 1;
    }
    .marksheet {
      width: 210mm;
      min-height: 297mm;
      margin: 10mm auto;
      padding: 10mm;
      border: 1px solid #000;
      page-break-after: always;
    }
    .sheet-top {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    .logo-slot {
      width: 80px;
      height: 80px;
      margin-right: 20px;
    }
    .logo-img {
      max-width: 100%;
      max-height: 100%;
    }
    .heading-block {
      flex: 1;
      text-align: center;
    }
    .motto, .school-name, .address, .estd, .iemis, .sheet-title {
      font-size: 14px;
      margin: 5px 0;
    }
    .school-name {
      font-size: 18px;
      font-weight: bold;
    }
    .sheet-title {
      font-size: 16px;
      font-weight: bold;
    }
    .student-info {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .student-info div {
      flex: 1 1 30%;
    }
    .marks-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    .marks-table th, .marks-table td {
      border: 1px solid #000;
      padding: 5px;
      text-align: center;
    }
    .marks-footer {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .signatures {
      display: flex;
      justify-content: space-between;
    }
    .ascii-frame {
      border: 2px solid #000;
      padding: 10px;
    }
    @media print {
      .container {
        display: block;
      }
      .ui-left {
        display: none;
      }
      .marksheet {
        margin: 5mm;
        border: none;
        transform: scale(0.95);
        transform-origin: top left;
      }
      .edit-marksheet-btn {
        display: none;
      }
    }
    .subject-input, .subject-mapping {
      display: flex;
      gap: 5px;
      margin-bottom: 5px;
    }
    .subject-input input, .subject-mapping select, .subject-mapping input {
      flex: 1;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 5px;
      width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-content label {
      display: block;
      margin-bottom: 10px;
    }
    .modal-content input, .modal-content select {
      width: 100%;
      padding: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="ui-left">
      <h3>üè´ School Information</h3>
      <label>School Name <input id="schoolNameInput" value="BAGMATI SECONDARY SCHOOL"></label>
      <label>Motto <input id="schoolMottoInput" value="Quality education is our Motto"></label>
      <label>Address <input id="schoolAddressInput" value="Chandrapur-1, Rautahat"></label>
      <label>Established <input id="estdInput" value="2020"></label>
      <label>IEMIS Code <input id="iemisInput" value="9846554489451"></label>

      <h3>üìö Academic Details</h3>
      <label>Term <input id="termInput" value="First Term"></label>
      <label>Year <input id="yearInput" value="2081"></label>
      <label>Class <input id="classInput" value="10"></label>
      <label>Pass Theory <input id="passTheoryInput" type="number" value="32"></label>
      <label>Pass Practical <input id="passPracticalInput" type="number" value="8"></label>
      <label>Full Theory <input id="fullTheoryInput" type="number" value="75"></label>
      <label>Full Practical <input id="fullPracticalInput" type="number" value="25"></label>
      <label>Issue Date
        <input id="issueYearInput" type="number" value="2081" style="width:4rem">
        <input id="issueMonthInput" type="number" value="08" style="width:3rem">
        <input id="issueDayInput" type="number" value="20" style="width:3rem">
      </label>

      <h3>üìö Subjects</h3>
      <div id="subjectContainer"></div>
      <button type="button" id="addSubjectBtn">‚ûï Add Subject</button>

      <h3>üìÇ Data Input</h3>
      <label>Upload Excel/CSV
        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
      </label>
      <label>Subject Column Mapping (optional)
        <div id="subjectMappingContainer"></div>
        <button type="button" id="confirmSubjectMapping" style="display:none">Confirm Mapping</button>
      </label>
      <button type="button" id="loadSampleBtn">üìä Load Sample</button>

      <h3>‚öôÔ∏è Display Options</h3>
      <label><input type="checkbox" id="displayModeToggle"> Show Grades Instead of Marks</label>
      <label><input type="checkbox" id="showPercentageToggle" checked> Show Percentage with GPA</label>
      <button type="button" id="generateBtn">üìà Generate Results</button>
    </div>
    <div class="ui-right">
      <div id="printArea"></div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal" style="display:none">
    <div class="modal-content">
      <h3>Edit Marksheet</h3>
      <div id="editForm"></div>
      <button type="button" id="saveEditBtn">Save Changes</button>
      <button type="button" id="cancelEditBtn">Cancel</button>
    </div>
  </div>

  <template id="marksheet-template">
    <div class="marksheet">
      <div class="sheet-top ascii-frame">
        <div class="logo-slot"><img class="logo-img" src="" alt="Logo" style="display:none"></div>
        <div class="heading-block">
          <div class="motto">"Quality education is our Motto"</div>
          <div class="school-name">BAGMATI SECONDARY SCHOOL</div>
          <div class="address">Chandrapur-1, Rautahat</div>
          <div class="estd">[ESTD : 2020]</div>
          <div class="iemis">IEMIS Code : 9846554489451</div>
          <div class="sheet-title">GRADE SHEET</div>
        </div>
      </div>
      <div class="student-info">
        <div>Name: <span class="st-name">Student Name</span></div>
        <div>Class: <span class="st-class">10</span></div>
        <div>Roll: <span class="st-roll">1</span></div>
        <div>Term: <span class="st-term">First Term</span></div>
        <div>Year: <span class="st-year">2081</span></div>
      </div>
      <table class="marks-table">
        <thead>
          <tr>
            <th>SN</th>
            <th>Subject</th>
            <th>CR</th>
            <th>TH</th>
            <th>PR</th>
            <th>Grade</th>
            <th>GP</th>
            <th>Remark</th>
          </tr>
        </thead>
        <tbody class="marks-body"></tbody>
      </table>
      <div class="marks-footer">
        <div class="marks-footer-left">
          <div>Total Marks: <span class="st-total-marks">0</span> / <span class="st-total-max">0</span></div>
          <div>GPA: <span class="st-gpa">0.00</span></div>
          <div>Rank: <span class="st-rank">-</span></div>
        </div>
        <div class="marks-footer-right">
          <div>Total Days: <span class="att-total">-</span></div>
          <div>Present: <span class="att-present">-</span></div>
          <div>Absent: <span class="att-absent">-</span></div>
          <div>Issue Date: <span class="issue-date">-</span></div>
        </div>
      </div>
      <div class="signatures">
        <div>Class Teacher</div>
        <div>Principal</div>
      </div>
      <button type="button" class="edit-marksheet-btn">Edit Marksheet</button>
    </div>
  </template>

  <script>
    const fileInput = document.getElementById('fileInput');
    const schoolNameInput = document.getElementById('schoolNameInput');
    const schoolMottoInput = document.getElementById('schoolMottoInput');
    const schoolAddressInput = document.getElementById('schoolAddressInput');
    const estdInput = document.getElementById('estdInput');
    const iemisInput = document.getElementById('iemisInput');
    const termInput = document.getElementById('termInput');
    const yearInput = document.getElementById('yearInput');
    const classInput = document.getElementById('classInput');
    const passTheoryInput = document.getElementById('passTheoryInput');
    const passPracticalInput = document.getElementById('passPracticalInput');
    const fullTheoryInput = document.getElementById('fullTheoryInput');
    const fullPracticalInput = document.getElementById('fullPracticalInput');
    const issueYearInput = document.getElementById('issueYearInput');
    const issueMonthInput = document.getElementById('issueMonthInput');
    const issueDayInput = document.getElementById('issueDayInput');
    const subjectContainer = document.getElementById('subjectContainer');
    const addSubjectBtn = document.getElementById('addSubjectBtn');
    const loadSampleBtn = document.getElementById('loadSampleBtn');
    const displayModeToggle = document.getElementById('displayModeToggle');
    const showPercentageToggle = document.getElementById('showPercentageToggle');
    const generateBtn = document.getElementById('generateBtn');
    const printArea = document.getElementById('printArea');
    const subjectMappingContainer = document.getElementById('subjectMappingContainer');
    const confirmSubjectMappingBtn = document.getElementById('confirmSubjectMapping');
    const editModal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    const saveEditBtn = document.getElementById('saveEditBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');

    let creditHourMap = {};
    let importedData = [];
    let studentsByClass = {};

    function toNum(val) {
      if (typeof val === 'number') return val;
      if (typeof val === 'string') {
        const num = parseFloat(val.replace(/[^0-9.]/g, ''));
        return isNaN(num) ? 0 : num;
      }
      return 0;
    }

    function gradeFromPercent(percent) {
      if (percent >= 90) return { grade: 'A+', gp: 4.0 };
      if (percent >= 80) return { grade: 'A', gp: 3.6 };
      if (percent >= 70) return { grade: 'B+', gp: 3.2 };
      if (percent >= 60) return { grade: 'B', gp: 2.8 };
      if (percent >= 50) return { grade: 'C+', gp: 2.4 };
      if (percent >= 40) return { grade: 'C', gp: 2.0 };
      if (percent >= 20) return { grade: 'D', gp: 1.6 };
      return { grade: 'NG', gp: 0 };
    }

    function remarkFromGP(gp) {
      if (gp >= 3.6) return 'Outstanding';
      if (gp >= 3.2) return 'Excellent';
      if (gp >= 2.8) return 'Very Good';
      if (gp >= 2.0) return 'Good';
      if (gp >= 1.6) return 'Satisfactory';
      return 'Needs Improvement';
    }

    function detectSubjectsFromHeaders(row) {
      const keys = Object.keys(row);
      const subjMap = {};
      const userSubjects = Object.keys(creditHourMap).map(s => s.toLowerCase());

      const patterns = [
        /^Subject_(.+?)(_TH|_PR)?$/i,
        /^(.+?)\s*(Theory|Practical|TH|PR)$/i,
        /^(.+?)$/i
      ];

      keys.forEach(k => {
        let matched = false;
        for (const pattern of patterns) {
          const m = k.match(pattern);
          if (m) {
            let base = m[1] ? m[1].replace(/_/g, ' ').trim() : k.trim();
            const normalizedBase = base.toLowerCase();
            const matchedSubject = userSubjects.find(us => 
              normalizedBase.includes(us) || us.includes(normalizedBase)
            );
            base = matchedSubject ? Object.keys(creditHourMap).find(s => s.toLowerCase() === matchedSubject) : base;

            if (!subjMap[base]) subjMap[base] = {};
            if (m[2] && /Theory|TH/i.test(m[2])) subjMap[base].thKey = k;
            else if (m[2] && /Practical|PR/i.test(m[2])) subjMap[base].prKey = k;
            else if (!m[2]) subjMap[base].nameKey = k;
            matched = true;
            break;
          }
        }
        if (!matched && !['Roll', 'Name', 'Class', 'Term', 'Year', 'IssueDate', 'TotalDays', 'Present', 'Absent', 'Remarks'].some(h => k.toLowerCase().includes(h.toLowerCase()))) {
          if (typeof row[k] === 'number' || (typeof row[k] === 'string' && !isNaN(parseFloat(row[k])))) {
            const base = k.replace(/_/g, ' ').trim();
            const normalizedBase = base.toLowerCase();
            const matchedSubject = userSubjects.find(us => 
              normalizedBase.includes(us) || us.includes(normalizedBase)
            );
            const finalBase = matchedSubject ? Object.keys(creditHourMap).find(s => s.toLowerCase() === matchedSubject) : base;
            if (!subjMap[finalBase]) subjMap[finalBase] = { nameKey: k };
          }
        }
      });

      const order = [];
      keys.forEach(k => {
        for (const base in subjMap) {
          if (subjMap[base].nameKey === k || subjMap[base].thKey === k || subjMap[base].prKey === k) {
            if (!order.includes(base)) order.push(base);
          }
        }
      });

      return order.map(base => ({
        base,
        nameKey: subjMap[base].nameKey || null,
        thKey: subjMap[base].thKey || null,
        prKey: subjMap[base].prKey || null
      }));
    }

    function addSubjectInput(subject = '', hours = 3) {
      const div = document.createElement('div');
      div.className = 'subject-input';
      div.innerHTML = `
        <input type="text" class="subject-name" value="${subject}" placeholder="Subject name" required>
        <input type="number" class="subject-hours" value="${hours}" placeholder="Credit hours" min="1" required>
        <button type="button" class="remove-subject-btn">√ó</button>
      `;
      subjectContainer.appendChild(div);
      
      div.querySelector('.remove-subject-btn').addEventListener('click', () => {
        div.remove();
        updateCreditHourMap();
      });
      
      div.querySelector('.subject-name').addEventListener('change', () => {
        const name = div.querySelector('.subject-name').value.trim();
        if (name && Object.keys(creditHourMap).some(s => s.toLowerCase() === name.toLowerCase() && s !== name)) {
          alert('Subject name already exists (case-insensitive)');
          div.querySelector('.subject-name').value = '';
        }
        updateCreditHourMap();
      });
      div.querySelector('.subject-hours').addEventListener('change', updateCreditHourMap);
    }

    function updateCreditHourMap() {
      creditHourMap = {};
      document.querySelectorAll('.subject-input').forEach(subjDiv => {
        const name = subjDiv.querySelector('.subject-name').value.trim();
        const hours = parseInt(subjDiv.querySelector('.subject-hours').value);
        if (name && !isNaN(hours) && hours > 0) {
          creditHourMap[name] = hours;
        }
      });
    }

    addSubjectBtn.addEventListener('click', () => addSubjectInput());

    fileInput.addEventListener('change', (ev) => {
      const file = ev.target.files[0];
      if (!file) return;
      
      const name = file.name.toLowerCase();
      const fileSizeMB = file.size / (1024 * 1024);
      
      if (fileSizeMB > 5) {
        alert("File too large. Maximum size is 5MB.");
        return;
      }
      
      try {
        if (name.endsWith('.csv')) {
          Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (res) => {
              if (res.errors.length > 0) {
                alert(`CSV parsing errors:\n${res.errors.map(e => e.message).join("\n")}`);
                return;
              }
              if (!res.data || res.data.length === 0) {
                alert("CSV file is empty or couldn't be parsed");
                return;
              }
              
              if (!res.meta.fields.includes('Roll') && !res.meta.fields.includes('roll')) {
                alert("CSV must contain a 'Roll' column");
                return;
              }
              
              importedData = res.data;
              showSubjectMapping(res.meta.fields);
            },
            error: (error) => {
              alert(`CSV parsing failed: ${error.message}`);
            }
          });
        } else if (name.endsWith('.xlsx') || name.endsWith('.xls')) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              let allData = [];

              workbook.SheetNames.forEach(sheetName => {
                const sheet = workbook.Sheets[sheetName];
                const sheetData = XLSX.utils.sheet_to_json(sheet, { defval: '' });

                if (sheetData && sheetData.length > 0) {
                  const firstRow = sheetData[0];
                  if (!('Roll' in firstRow) && !('roll' in firstRow)) {
                    alert(`Sheet "${sheetName}" must contain a 'Roll' column`);
                    return;
                  }
                  sheetData.forEach(row => {
                    row['Class'] = row['Class'] || row['class'] || row['Grade'] || sheetName;
                  });
                  allData = allData.concat(sheetData);
                }
              });

              if (!allData || allData.length === 0) {
                alert("Excel file is empty or couldn't be parsed");
                return;
              }

              importedData = allData;
              const headers = Object.keys(allData[0]);
              showSubjectMapping(headers);
            } catch (e) {
              alert(`Excel parsing failed: ${e.message}`);
            }
          };
          reader.onerror = () => {
            alert("Error reading Excel file");
          };
          reader.readAsArrayBuffer(file);
        } else {
          alert('Unsupported file type. Please upload a .csv or .xlsx file.');
        }
      } catch (e) {
        alert(`Error processing file: ${e.message}`);
      }
    });

    function showSubjectMapping(headers) {
      subjectMappingContainer.innerHTML = '';
      const potentialSubjectHeaders = headers.filter(h => 
        !['Roll', 'Name', 'Class', 'Term', 'Year', 'IssueDate', 'TotalDays', 'Present', 'Absent', 'Remarks']
          .some(protected => h.toLowerCase().includes(protected.toLowerCase()))
      );

      potentialSubjectHeaders.forEach(header => {
        const div = document.createElement('div');
        div.className = 'subject-mapping';
        div.innerHTML = `
          <label>Column: ${header}
            <select class="subject-mapping-select">
              <option value="">Ignore</option>
              ${Object.keys(creditHourMap).map(s => `<option value="${s}">${s}</option>`).join('')}
              <option value="custom">Custom Subject</option>
            </select>
            <input type="text" class="custom-subject-name" placeholder="Enter subject name" style="display:none">
          </label>
        `;
        subjectMappingContainer.appendChild(div);

        const select = div.querySelector('.subject-mapping-select');
        select.addEventListener('change', () => {
          const customInput = div.querySelector('.custom-subject-name');
          customInput.style.display = select.value === 'custom' ? 'block' : 'none';
        });
      });

      confirmSubjectMappingBtn.style.display = 'block';
      confirmSubjectMappingBtn.onclick = () => {
        const mappings = {};
        document.querySelectorAll('.subject-mapping').forEach(div => {
          const header = div.querySelector('label').textContent.replace('Column: ', '').trim();
          let subject = div.querySelector('.subject-mapping-select').value;
          if (subject === 'custom') {
            subject = div.querySelector('.custom-subject-name').value.trim();
            if (subject && !creditHourMap[subject]) {
              creditHourMap[subject] = 3;
              addSubjectInput(subject, 3);
            }
          }
          if (subject) {
            mappings[header] = subject;
          }
        });

        importedData = importedData.map(row => {
          const newRow = { ...row };
          Object.keys(mappings).forEach(header => {
            const subject = mappings[header];
            const isTheory = header.toLowerCase().includes('theory') || header.toLowerCase().includes('th');
            const isPractical = header.toLowerCase().includes('practical') || header.toLowerCase().includes('pr');
            const baseHeader = isTheory || isPractical ? `Subject_${subject.replace(/\s+/g, '_')}` : header;
            if (isTheory) {
              newRow[`Subject_${subject.replace(/\s+/g, '_')}_TH`] = row[header];
            } else if (isPractical) {
              newRow[`Subject_${subject.replace(/\s+/g, '_')}_PR`] = row[header];
            } else {
              newRow[`Subject_${subject.replace(/\s+/g, '_')}`] = subject;
              newRow[`Subject_${subject.replace(/\s+/g, '_')}_TH`] = row[header];
            }
            if (isTheory || isPractical || !mappings[header]) {
              delete newRow[header];
            }
          });
          return newRow;
        });

        subjectMappingContainer.innerHTML = '';
        confirmSubjectMappingBtn.style.display = 'none';
        alert(`Successfully mapped ${Object.keys(mappings).length} columns. Click Generate Results.`);
      };
    }

    loadSampleBtn.addEventListener('click', () => {
      const subjects = Object.keys(creditHourMap);
      if (subjects.length === 0) {
        alert('Please add some subjects first');
        return;
      }
      
      importedData = [];
      const classes = ['Grade 9', 'Grade 10', 'Grade 11'];
      for (let i = 1; i <= 10; i++) {
        const className = classes[i % classes.length];
        const row = {
          Roll: i,
          Name: `Student ${i}`,
          Class: className,
          Term: termInput.value || 'First Term',
          Year: yearInput.value || '2081',
          IssueDate: `${issueYearInput.value}-${issueMonthInput.value}-${issueDayInput.value}`,
          TotalDays: 220,
          Present: 210 - i,
          Absent: 10 + i,
          Remarks: i % 2 ? 'Needs improvement' : 'Good'
        };
        
        subjects.forEach((s, idx) => {
          const nameVariations = [`${s} Theory`, `${s}_PR`, s];
          const base = nameVariations[idx % nameVariations.length].replace(/\s+/g, '_');
          row[base] = base.includes('Theory') || !base.includes('PR') ? Math.max(0, 90 - i*3 - idx) : Math.max(0, 18 - (i % 5));
        });
        
        importedData.push(row);
      }
      
      alert('Sample data loaded (10 students across multiple classes with varied subject names). Click Generate Results.');
    });

    function validateInputs() {
      const errors = [];
      if (!schoolNameInput.value.trim()) errors.push('School Name is required');
      if (!schoolAddressInput.value.trim()) errors.push('School Address is required');
      if (!estdInput.value.trim()) errors.push('Established Year is required');
      if (!iemisInput.value.trim()) errors.push('IEMIS Code is required');
      if (!termInput.value.trim()) errors.push('Term is required');
      if (!yearInput.value.trim()) errors.push('Year is required');
      if (!classInput.value.trim()) errors.push('Class is required');
      if (!passTheoryInput.value || passTheoryInput.value < 0) errors.push('Pass Theory must be a positive number');
      if (!passPracticalInput.value || passPracticalInput.value < 0) errors.push('Pass Practical must be a positive number');
      if (!fullTheoryInput.value || fullTheoryInput.value < 0) errors.push('Full Theory must be a positive number');
      if (!fullPracticalInput.value || fullPracticalInput.value < 0) errors.push('Full Practical must be a positive number');
      if (!issueYearInput.value || !issueMonthInput.value || !issueDayInput.value) errors.push('Issue Date is incomplete');
      return errors;
    }

    function processStudent(row, subjects) {
      const name = row['Name'] || row['name'] || '';
      const roll = row['Roll'] || row['roll'] || row['Roll No'] || row['RollNo'] || '';
      const term = row['Term'] || termInput.value || '';
      const year = row['Year'] || yearInput.value || '';
      const issueDate = row['IssueDate'] || row['Issue Date'] || row['Issue'] || 
        `${issueYearInput.value}-${issueMonthInput.value}-${issueDayInput.value}`;
      const totalDays = row['TotalDays'] || row['Total Days'] || '';
      const present = row['Present'] || row['PresentDays'] || row['Present Days'] || '';
      const absent = row['Absent'] || row['AbsentDays'] || row['Absent Days'] || '';
      const remarks = row['Remarks'] || '';
      const className = row['Class'] || row['class'] || row['Grade'] || classInput.value || '';

      const passTheory = toNum(passTheoryInput.value);
      const passPractical = toNum(passPracticalInput.value);
      const fullTheory = toNum(fullTheoryInput.value);
      const fullPractical = toNum(fullPracticalInput.value);

      const subjArr = subjects.map((s) => {
        let displayName = s.base;
        if (s.nameKey && row[s.nameKey]) displayName = row[s.nameKey];

        const thRaw = s.thKey ? toNum(row[s.thKey]) : (s.nameKey ? toNum(row[s.nameKey]) : 0);
        const prRaw = s.prKey ? toNum(row[s.prKey]) : 0;
        
        const thPercent = fullTheory > 0 ? (thRaw / fullTheory) * 100 : 0;
        const prPercent = fullPractical > 0 ? (prRaw / fullPractical) * 100 : 0;
        const totalPercent = (thPercent * (fullTheory/100)) + (prPercent * (fullPractical/100));

        let thGrade = { grade: 'NG', gp: 0 };
        let prGrade = gradeFromPercent(prPercent);

        if (thRaw >= passTheory) {
          thGrade = gradeFromPercent(thPercent);
        }

        let finalGrade;
        if (thRaw >= passTheory && prRaw >= passPractical) {
          finalGrade = gradeFromPercent(totalPercent);
        } else {
          finalGrade = { grade: 'NG', gp: 0 };
        }

        const pass = (thRaw >= passTheory) && (prRaw >= passPractical);
        const creditHours = creditHourMap[displayName] ?? '3';

        return {
          subject: displayName,
          creditHours,
          thRaw, prRaw, 
          thPercent, prPercent, totalPercent,
          thLetter: thGrade.grade,
          prLetter: prGrade.grade,
          grade: finalGrade.grade,
          gp: finalGrade.gp,
          pass,
          remark: remarkFromGP(finalGrade.gp)
        };
      });

      const totalMarks = subjArr.reduce((a,b) => a + b.totalPercent, 0);
      const numSubjects = subjArr.length;
      const totalMax = numSubjects * 100;
      const avgGPA = subjArr.length ? (subjArr.reduce((a,b) => a + b.gp,0) / subjArr.length) : 0;
      const anyFail = subjArr.some(s => !s.pass);
      const result = anyFail ? 'Fail' : 'Pass';

      return {
        name, roll, term, year, issueDate, totalDays, present, absent, remarks,
        className,
        subjects: subjArr,
        totalMarks, totalMax, avgGPA, result
      };
    }

    function generateMarksheet(student, subjects, className) {
      const tpl = document.getElementById('marksheet-template');
      const clone = tpl.content.cloneNode(true);

      // Update school info
      clone.querySelector('.school-name').textContent = schoolNameInput.value;
      clone.querySelector('.motto').textContent = `"${schoolMottoInput.value}"`;
      clone.querySelector('.address').textContent = schoolAddressInput.value;
      clone.querySelector('.estd').textContent = estdInput.value;
      clone.querySelector('.iemis').textContent = iemisInput.value;

      // Dynamic title
      const titleParts = [];
      if (student.term) titleParts.push(student.term);
      if (student.className) titleParts.push(`Grade Sheet for ${student.className}`);
      if (student.year) titleParts.push(student.year);
      clone.querySelector('.sheet-title').textContent = titleParts.join(' ') || 'GRADE SHEET';

      // Update student info
      clone.querySelector('.st-name').textContent = student.name;
      clone.querySelector('.st-class').textContent = student.className;
      clone.querySelector('.st-roll').textContent = student.roll;
      clone.querySelector('.st-term').textContent = student.term;
      clone.querySelector('.st-year').textContent = student.year;

      const tbody = clone.querySelector('.marks-body');
      student.subjects.forEach((sub, idx) => {
        const tr = document.createElement('tr');
        const showGrades = displayModeToggle.checked;
        const thDisplay = showGrades ? sub.thLetter : sub.thRaw;
        const prDisplay = showGrades ? sub.prLetter : sub.prRaw;
        
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td style="text-align:left;padding-left:6px">${sub.subject}</td>
          <td>${sub.creditHours}</td>
          <td>${thDisplay}</td>
          <td>${prDisplay}</td>
          <td>${sub.grade}</td>
          <td>${sub.gp.toFixed(2)}</td>
          <td>${sub.remark}</td>
        `;
        tbody.appendChild(tr);
      });

      // Update summary row
      const showPercentage = showPercentageToggle.checked;
      const gpaEl = clone.querySelector('.st-gpa');
      gpaEl.textContent = student.avgGPA.toFixed(2);
      if (showPercentage) {
        const percentage = (student.totalMarks / student.totalMax * 100).toFixed(2);
        gpaEl.textContent += ` (${percentage}%)`;
      }

      clone.querySelector('.st-rank').textContent = student.rank === '-' ? '-' : `${student.rank} / ${studentsByClass[className].passed.length}`;

      clone.querySelector('.st-total-marks').textContent = Math.round(student.totalMarks);
      clone.querySelector('.st-total-max').textContent = student.totalMax;
      clone.querySelector('.att-total').textContent = student.totalDays;
      clone.querySelector('.att-present').textContent = student.present;
      clone.querySelector('.att-absent').textContent = student.absent;
      clone.querySelector('.issue-date').textContent = student.issueDate;

      // Add logo if available
      const logoImg = clone.querySelector('.logo-img');
      const logoUrl = localStorage.getItem('schoolLogo');
      if (logoUrl) {
        logoImg.src = logoUrl;
        logoImg.style.display = 'block';
      }

      // Add edit button functionality
      const editBtn = clone.querySelector('.edit-marksheet-btn');
      editBtn.addEventListener('click', () => showEditModal(student, subjects, className));

      // Set data attributes for identification
      clone.querySelector('.marksheet').setAttribute('data-roll', student.roll);
      clone.querySelector('.marksheet').setAttribute('data-class', student.className);

      return clone;
    }

    function showEditModal(student, subjects, className) {
      editForm.innerHTML = `
        <label>Name <input type="text" id="editName" value="${student.name}"></label>
        <label>Roll <input type="text" id="editRoll" value="${student.roll}"></label>
        <label>Class <input type="text" id="editClass" value="${student.className}"></label>
        <label>Term <input type="text" id="editTerm" value="${student.term}"></label>
        <label>Year <input type="text" id="editYear" value="${student.year}"></label>
        <label>Total Days <input type="number" id="editTotalDays" value="${student.totalDays}"></label>
        <label>Present <input type="number" id="editPresent" value="${student.present}"></label>
        <label>Absent <input type="number" id="editAbsent" value="${student.absent}"></label>
        <label>Remarks <input type="text" id="editRemarks" value="${student.remarks}"></label>
        <h4>Subjects</h4>
        ${subjects.map(s => `
          <label>${s.base} Theory <input type="number" id="edit_${s.thKey || s.nameKey}" value="${student.subjects.find(sub => sub.subject === s.base)?.thRaw || 0}"></label>
          ${s.prKey ? `<label>${s.base} Practical <input type="number" id="edit_${s.prKey}" value="${student.subjects.find(sub => sub.subject === s.base)?.prRaw || 0}"></label>` : ''}
        `).join('')}
      `;
      editModal.style.display = 'flex';

      saveEditBtn.onclick = () => {
        const updatedRow = {
          Name: document.getElementById('editName').value.trim(),
          Roll: document.getElementById('editRoll').value.trim(),
          Class: document.getElementById('editClass').value.trim(),
          Term: document.getElementById('editTerm').value.trim(),
          Year: document.getElementById('editYear').value.trim(),
          TotalDays: toNum(document.getElementById('editTotalDays').value),
          Present: toNum(document.getElementById('editPresent').value),
          Absent: toNum(document.getElementById('editAbsent').value),
          Remarks: document.getElementById('editRemarks').value.trim()
        };

        subjects.forEach(s => {
          if (s.thKey || s.nameKey) {
            updatedRow[s.thKey || s.nameKey] = toNum(document.getElementById(`edit_${s.thKey || s.nameKey}`).value);
          }
          if (s.prKey) {
            updatedRow[s.prKey] = toNum(document.getElementById(`edit_${s.prKey}`).value);
          }
        });

        // Update importedData
        const index = importedData.findIndex(row => (row.Roll || row.roll) === student.roll && (row.Class || row.class || row.Grade || classInput.value) === student.className);
        if (index !== -1) {
          importedData[index] = updatedRow;
        }

        // Update studentsByClass
        const updatedStudent = processStudent(updatedRow, subjects);
        const classStudents = studentsByClass[className];
        if (classStudents) {
          classStudents.passed = classStudents.passed.filter(s => s.roll !== student.roll);
          classStudents.failed = classStudents.failed.filter(s => s.roll !== student.roll);
          if (updatedStudent.result === 'Pass') {
            classStudents.passed.push(updatedStudent);
          } else {
            classStudents.failed.push(updatedStudent);
          }
          classStudents.passed.sort((a, b) => {
            if (b.avgGPA !== a.avgGPA) return b.avgGPA - a.avgGPA;
            return b.totalMarks - a.totalMarks;
          });
          classStudents.passed.forEach((s, i) => s.rank = i + 1);
          classStudents.failed.forEach(s => s.rank = '-');
        }

        // Replace the specific marksheet
        const marksheetDiv = printArea.querySelector(`.marksheet[data-roll="${student.roll}"][data-class="${student.className}"]`);
        if (marksheetDiv) {
          const newMarksheet = generateMarksheet(updatedStudent, subjects, className);
          marksheetDiv.replaceWith(newMarksheet);
        }

        editModal.style.display = 'none';
        alert('Marksheet updated successfully.');
      };

      cancelEditBtn.onclick = () => {
        editModal.style.display = 'none';
      };
    }

    generateBtn.addEventListener('click', () => {
      const validationErrors = validateInputs();
      if (validationErrors.length > 0) {
        alert("Validation errors:\n" + validationErrors.join("\n"));
        return;
      }

      if (!importedData || importedData.length === 0) {
        alert('No data loaded. Upload Excel/CSV or click Load Sample.');
        return;
      }

      const subjects = detectSubjectsFromHeaders(importedData[0]);
      if (subjects.length === 0) {
        alert('No subjects detected. Ensure columns match defined subjects or use the mapping tool.');
        return;
      }

      const students = importedData.map(row => processStudent(row, subjects));

      // Group students by class
      studentsByClass = {};
      students.forEach(stu => {
        const className = stu.className || 'Unknown';
        if (!studentsByClass[className]) {
          studentsByClass[className] = { passed: [], failed: [] };
        }
        if (stu.result === 'Pass') {
          studentsByClass[className].passed.push(stu);
        } else {
          studentsByClass[className].failed.push(stu);
        }
      });

      // Sort and rank students within each class
      Object.keys(studentsByClass).forEach(className => {
        const classGroup = studentsByClass[className];
        classGroup.passed.sort((a, b) => {
          if (b.avgGPA !== a.avgGPA) return b.avgGPA - a.avgGPA;
          return b.totalMarks - a.totalMarks;
        });
        classGroup.passed.forEach((s, i) => s.rank = i + 1);
        classGroup.failed.forEach(s => s.rank = '-');
      });

      // Render marksheets
      printArea.innerHTML = '';
      Object.keys(studentsByClass).forEach(className => {
        const classStudents = [...studentsByClass[className].passed, ...studentsByClass[className].failed];
        classStudents.forEach(stu => {
          const marksheet = generateMarksheet(stu, subjects, className);
          printArea.appendChild(marksheet);
        });
      });

      alert(`Generated ${students.length} marksheet(s) for ${Object.keys(studentsByClass).length} class(es).`);
    });

    // Initialize with sample subjects
    addSubjectInput('Mathematics', 4);
    addSubjectInput('Science', 4);
    addSubjectInput('Physics', 3);
  </script>
</body>
</html>